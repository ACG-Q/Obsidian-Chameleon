name: Release Obsidian plugin

on:
  push:
    tags:
      - "*"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18.x"

      - name: Build plugin
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm install
          echo "ğŸ”¨ Building plugin..."
          npm run build
          echo "âœ… Build completed successfully!"

      - name: Package build artifacts
        run: |
          echo "ğŸ“¦ Packaging build artifacts..."
          zip plugin.zip main.js dictionary.json manifest.json
          echo "ğŸ“Š Artifact details:"
          ls -la plugin.zip main.js dictionary.json manifest.json
          echo "âœ… Packaging completed successfully!"

      - name: Create release
        uses: actions/github-script@v7
        with:
          script: |
            const tag = context.ref.replace('refs/tags/', '');
            const fs = require('fs');
            const changelogPath = 'CHANGELOG.md';
            console.log(`ğŸ“ Reading changelog from ${changelogPath}...`);
            const changelog = fs.readFileSync(changelogPath, 'utf8');
            console.log(`ğŸ“‹ Changelog content length: ${changelog.length} characters`);

            console.log(`ğŸ·ï¸ Creating GitHub Release for tag: ${tag}`);
            // åˆ›å»º GitHub Release
            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: tag,
              body: changelog,
              draft: false,
              prerelease: false
            });
            console.log(`âœ… GitHub Release created successfully with ID: ${release.data.id}`);

            // ä¸Šä¼ æ’ä»¶èµ„æº
            const assetPaths = ['plugin.zip', 'main.js', 'dictionary.json', 'manifest.json'];
            console.log(`ğŸ“¤ Uploading ${assetPaths.length} assets to the release...`);
            
            for (const assetPath of assetPaths) {
              const assetName = assetPath;
              const fileStats = fs.statSync(assetPath);
              console.log(`ğŸ“¦ Uploading ${assetName} (${(fileStats.size / 1024).toFixed(2)} KB)...`);
              
              await github.rest.repos.uploadReleaseAsset({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.data.id,
                name: assetName,
                data: fs.readFileSync(assetPath)
              });
              
              console.log(`âœ… Asset ${assetName} uploaded successfully!`);
            }
            
            console.log(`ğŸ‰ Release process completed successfully!`);
            console.log(`ğŸ”— Release URL: ${release.data.html_url}`);
            console.log(`ğŸ“Š Release summary:`);
            console.log(`   - Tag: ${tag}`);
            console.log(`   - Assets: ${assetPaths.join(', ')}`);
            console.log(`   - Created at: ${new Date().toISOString()}`);
